[TOC]

# Openwrt

# 软路由三种接入方式测试

## 主路由

放弃光猫拨号，改为桥接。

![image-20230924220208423](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924220208423.png)



### 性能测试

<img src="%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924220527134.png" alt="image-20230924220527134" style="zoom:50%;" />



## 二级路由

软路由WAN口设置为DHCP客户端

![image-20230924220554866](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924220554866.png)

LAN口多一次NAT，对性能稍有影响

![image-20230924220641625](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924220641625.png)

![image-20230924220906943](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924220906943.png)

## 旁路由

![image-20230924221003605](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924221003605.png)

## 总结

硬路由能开AP就开AP

![image-20230924221144645](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924221144645.png)

![image-20230924221200216](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924221200216.png)



# 软路由选择

## 两个网口以上使用场景

![image-20230924204102832](C:/Users/25064/AppData/Roaming/Typora/typora-user-images/image-20230924204102832.png)

---

## 软路由多网口意义

+ 多台宽带接入，需要多个WAN口
+ 软路由内网传输需要消耗一定的CPU。性能不好的软路由，最好搭配交换机

---

## 网口速率选择

+ 目前运营商主流千兆网，2.5网口成品软路由只能提升内网传输速率

---

## 网卡选择

+ 普通家用intel和螃蟹区别不大，如果想在软路由上玩虚拟化，最好选intel网卡

---

## 软路由硬盘（读写速率）

+ x86软路由目前使用最多的是mSATA硬盘
+ ARM软路由使用的是TF卡当作硬盘
+ 都不会影响软路由网速，软路由不是NAS，不会对硬盘频繁读写
+ 软路由系统对硬盘要求不大，一般一两个G就够了
+ 虚拟机用户看需求

---

## 软路由内存

+ 在内存已经够用情况下，更多的内存并不能提升网速
+ 如果想在软路由上玩虚拟环境，虚拟平台PVE的内存要求较低，EXSI需要8G内存

---

## 软路由CPU（ARM/x86）

ARM架构CPU比不上x86架构CPU，但是ARM便宜和低功耗

+  在软路由上玩虚拟环境，x86
  + CPU尽量选择中高端
  + 虚拟机对硬件性能有损耗
  + 小白用户慎用
+ ARM
  + 性能较低的R2S跑国外下载500M左右，CPU最高达94%（一般家用足够，油管4K无压力）
  + 性能较高的R4S跑国外下载900M左右，CPU最高大50%

---

## 总结

+ 软路由作为特殊的网络设备，CPU和网卡重要性要大于内存和硬盘
+ CPU决定了速度，网卡决定了稳定性
+ 合适最重要

---

# 初始设置

1. 输入系统`.img.gz`后缀

2. 连接家庭网络

   ![image-20230924223043846](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924223043846.png)

   ![image-20230924223338565](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924223338565.png)











# 旁路由设置（R2S）

1. 软路由LAN口接到主路由LAN口

   <img src="C:/Users/25064/AppData/Roaming/Typora/typora-user-images/image-20230924210658317.png" alt="image-20230924210658317" style="zoom:50%;" />

2. 设置固件

   + 问题一：打不开软路由后台？原因：旁路由和主路由并不在同一网段

     + 例如小米路由器在`192.168.31.1`网段，而软路由却在`192.168.2.1`网段（各编译版本网段可能不一样）

     + 打开电脑修改客户端，修改至和软路由同一个网段，这样就能直接进入后台（各编译版本可能密码不一样）

       <img src="C:/Users/25064/AppData/Roaming/Typora/typora-user-images/image-20230924211231902.png" alt="image-20230924211231902" style="zoom:50%;" />

   + 旁路由设置

     1. 登录到后台修改旁路由网络—LAN口，必须和主路由在同一网段

        <img src="%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924211731293.png" alt="image-20230924211731293"  />

     2. 电脑改回自动获取IP

     3. 通过新地址`192.168.31.2`进入后台

   + 旁路有设置重点（网关DNS DHCP）

     4. DNS：填上本地运营商的地址，不知道填上主路由地址也行

     5. DHCP：建议局域网内DHCP交给主路由。交给旁路由如果旁路由发生故障，局域网瘫痪。

        ![image-20230924213350361](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924213350361.png)

     6. 小的设置

        + IPv6分配长度禁用

          ![image-20230924213605073](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924213605073.png)

        + 取消内置的IPv6管理

          ![image-20230924213629546](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924213629546.png)

     7. 防火墙设置

        IP动态伪装一定要勾选

        ![image-20230924214453187](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924214453187.png)

     8. 终端设置

        - 非侵入式：现有网络设置不变，自己选择设备是否走旁路由。但每个走旁路由的设备都要手动设置IP网关和DNS比较繁琐。

          修改终端设备，网关改为旁路由地址，DNS填主路由地址

        - 侵入式：旁路由完全接管局域网网关

          看似是旁路由完全接管，但是却设置在主路由DHCP。让主路由DHCP分配下来的网关直接是旁路由地址

          <img src="%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230924215629015.png" alt="image-20230924215629015" style="zoom:67%;" />

          

        

     


## 总结

1. 旁路由必须和主路由在同一网段
2. 旁路由的网关必须指向主路由
3. 防火墙开启IP动态伪装



# 主路由













# 二级路由

## 路由器设置为无线路由器

+ 采用光猫拨号，无线路由器设置几乎不用动
+ 无线路由器WAN设置DHCP，软路由由上级光猫分配地址，无线路由器由R2S分配地址，LAN口的DHCP服务也就是局域网分配IP服务，局域网IP不能和R2S在同一网段
+ 多了个路由器，多了一次转发

![image-20230925075513503](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230925075513503.png)



## 路由器设置为无线交换机

路由器设置为AP模式，无线交换机ip和软路由同网段，默认网关和DNS设置为软路由ip

![image-20230925080357623](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230925080357623.png)

小米路由器进入后台，常用设置—上网设置—工作模式切换—有线中继模式

设置为AP后，以前的后台管理地址不可用，需要记住新的后台管理地址

所有口都会变为LAN口

## 设置R2S

通电系统启动好后，sys灯变为常亮，LAN口和WAN口指示灯也会亮

![image-20230925084945369](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230925084945369.png)

修改软路由WAN口

+ 光猫拨号：无需修改，协议就是DHCP客户端

  ![image-20230925085324813](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230925085324813.png)

+ 软路由拨号：修改协议，需要重启光猫

  ![image-20230925085357358](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230925085357358.png)

修改软路由LAN口，关闭内置的IPv6管理

![image-20230925085451462](%E8%BD%AF%E8%B7%AF%E7%94%B1.assets/image-20230925085451462.png)































